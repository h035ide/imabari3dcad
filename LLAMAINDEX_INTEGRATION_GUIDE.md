# LlamaIndex 統合ガイド

このドキュメントは、新しく導入されたLlamaIndexベースのハイブリッド検索機能に関する変更点、実行方法、およびテスト方法について説明します。

## 1. 変更点

- **ハイブリッド検索エンジンの刷新:**
  - 従来の手実装による検索ツール (`GraphSearchTool`) から、LlamaIndexフレームワークを利用した新しい検索ツール (`LlamaIndexHybridSearchTool`) に移行しました。
  - 新しいツールはLlamaIndexの `RouterQueryEngine` を利用しており、ユーザーのクエリの意図に応じて、最適な検索方法（ベクトル検索またはグラフ検索）を自動的に選択します。

- **フィーチャーフラグの導入:**
  - 新旧の検索ツールは、環境変数 `USE_LLAMAINDEX` を使って切り替えることができます。これにより、新機能の安全なテストと、必要に応じた従来機能へのフォールバックが可能です。
  - このフラグはプロジェクトルートの `.env` ファイルで設定します。

- **依存関係の変更:**
  - `llama-index` 関連のライブラリが `requirements.txt` に追加されました。
  - ディスク容量の問題を回避するため、オプション機能であったRe-Ranking用の `sentence-transformers` ライブラリは削除されました。

## 2. 実行方法

エージェントを実行する際に、使用する検索ツールを選択できます。

### 従来通りの検索ツール (`GraphSearchTool`) を使用する場合

`.env` ファイルで `USE_LLAMAINDEX` を `"0"` に設定するか、この行をコメントアウトしてください。

```env
# .env file
# ...
USE_LLAMAINDEX="0"
```

### 新しいLlamaIndex検索ツール (`LlamaIndexHybridSearchTool`) を使用する場合

`.env` ファイルで `USE_LLAMAINDEX` を `"1"` に設定してください。

```env
# .env file
# ...
USE_LLAMAINDEX="1"
```

設定後、通常通り `main.py` を実行することで、指定した検索ツールを備えたエージェントが起動します。

```bash
python code_generator/main.py
```

## 3. テスト方法

既存の単体テストスイートが環境依存の問題で不安定だったため、新機能の動作確認用に専用のテストスクリプト `manual_test.py` を作成しました。

このスクリプトは、エージェントを初期化し、固定のテストクエリ（"一辺が50mmの正方形のキューブを作成してください"）を実行します。

**テスト手順:**

1.  **テストしたい検索ツールを選択:** 上記「2. 実行方法」に従って、`.env` ファイルの `USE_LLAMAINDEX` フラグを設定します。
2.  **テストスクリプトの実行:** 以下のコマンドを実行します。

    ```bash
    python manual_test.py
    ```

3.  **ログの確認:**
    - スクリプトを実行すると、エージェントの初期化ログが出力されます。
    - `USE_LLAMAINDEX="0"` の場合: `INFO - 従来の GraphSearchTool を使用します。` というログが表示されることを確認します。
    - `USE_LLAMAINDEX="1"` の場合: `INFO - LlamaIndexHybridSearchTool を使用します。` というログが表示されることを確認します。

**注意:** このテストは、ツールの初期化が正しく行われることを確認するためのものです。OpenAI APIキーやNeo4jデータベースへの接続が有効でない場合、スクリプトは途中でエラー終了しますが、初期化ログの確認は可能です。
